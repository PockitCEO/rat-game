{"version":3,"sources":["../src/fao.js","../src/tevmUnplugin.js"],"names":["existsSync","readFile","readFileSync","writeFileSync","statSync","stat","mkdirSync","writeFile","mkdir","access","defaultSolc","z","releases","bundler","config","runPromise","loadConfig","catchTag","logWarning","map","defaultConfig","createCache","getContractPath","createSolc","createRequire"],"mappings":"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","file":"index.cjs","sourcesContent":["import { existsSync, mkdirSync, readFileSync, statSync, writeFileSync } from 'node:fs'\nimport { access, mkdir, readFile, stat, writeFile } from 'node:fs/promises'\n\n/**\n * Default file access object implementation using Node.js file system APIs.\n *\n * This object provides a unified interface for file system operations that works\n * consistently across different build tools. It implements the FileAccessObject\n * interface required by the Tevm bundler system, providing both synchronous and\n * asynchronous file operations.\n *\n * The file access object is used for:\n * - Reading Solidity source files\n * - Writing compiled artifacts to the cache\n * - Checking if files exist\n * - Creating directories for cache storage\n * - Getting file metadata (stats)\n *\n * @type {import(\"@tevm/base-bundler\").FileAccessObject}\n *\n * @example\n * ```javascript\n * import { fao } from '@tevm/unplugin'\n * import { bundler } from '@tevm/base-bundler'\n *\n * // Use the file access object with the bundler\n * const tevmBundler = bundler(\n *   config,\n *   console,\n *   fao,   // Pass the file access object\n *   solc,\n *   cache\n * )\n * ```\n *\n * @internal This is primarily used internally by the unplugin implementation\n */\nexport const fao = {\n\t/**\n\t * Synchronously checks if a file exists\n\t * @param {string} path - Path to the file\n\t * @returns {boolean} - True if the file exists, false otherwise\n\t */\n\texistsSync,\n\n\t/**\n\t * Asynchronously reads a file as text\n\t * @param {string} path - Path to the file\n\t * @param {BufferEncoding} encoding - File encoding\n\t * @returns {Promise<string>} - Promise resolving to file contents\n\t */\n\treadFile,\n\n\t/**\n\t * Synchronously reads a file as text\n\t * @param {string} path - Path to the file\n\t * @param {BufferEncoding} encoding - File encoding\n\t * @returns {string} - File contents\n\t */\n\treadFileSync,\n\n\t/**\n\t * Synchronously writes data to a file\n\t * @param {string} path - Path to the file\n\t * @param {string} data - Data to write\n\t * @returns {void}\n\t */\n\twriteFileSync,\n\n\t/**\n\t * Synchronously gets file stats\n\t * @param {string} path - Path to the file\n\t * @returns {import('fs').Stats} - File stats\n\t */\n\tstatSync,\n\n\t/**\n\t * Asynchronously gets file stats\n\t * @param {string} path - Path to the file\n\t * @returns {Promise<import('fs').Stats>} - Promise resolving to file stats\n\t */\n\tstat,\n\n\t/**\n\t * Synchronously creates a directory\n\t * @param {string} path - Path to create\n\t * @param {import('fs').MakeDirectoryOptions} [options] - Options\n\t * @returns {string|undefined} - Path to created directory\n\t */\n\tmkdirSync,\n\n\t/**\n\t * Asynchronously writes data to a file\n\t * @param {string} path - Path to the file\n\t * @param {string} data - Data to write\n\t * @returns {Promise<void>} - Promise that resolves when write is complete\n\t */\n\twriteFile,\n\n\t/**\n\t * Asynchronously creates a directory\n\t * @param {string} path - Path to create\n\t * @param {import('fs').MakeDirectoryOptions} [options] - Options\n\t * @returns {Promise<string|undefined>} - Promise resolving to created directory path\n\t */\n\tmkdir,\n\n\t/**\n\t * Asynchronously checks if a file exists\n\t * @param {string} path - Path to the file\n\t * @returns {Promise<boolean>} - Promise resolving to true if file exists, false otherwise\n\t */\n\texists: async (path) => {\n\t\ttry {\n\t\t\tawait access(path)\n\t\t\treturn true\n\t\t} catch (_e) {\n\t\t\treturn false\n\t\t}\n\t},\n}\n","import { createRequire } from 'node:module'\nimport { bundler, getContractPath } from '@tevm/base-bundler'\nimport { createCache } from '@tevm/bundler-cache'\nimport { defaultConfig, loadConfig } from '@tevm/config'\nimport { createSolc, releases } from '@tevm/solc'\nimport { catchTag, logWarning, map, runPromise } from 'effect/Effect'\nimport defaultSolc from 'solc'\nimport { z } from 'zod'\nimport { fao } from './fao.js'\n\nconst defaultVersion = defaultSolc.version().slice(0, defaultSolc.version().indexOf('+'))\n\n/**\n * @type {import(\"zod\").ZodSchema<import('@tevm/solc').SolcVersions>}\n */\nconst compilerOptionValidator = z\n\t.union(\n\t\t/**\n\t\t * @type {any}\n\t\t */\n\t\t(Object.keys(releases).map((release) => z.literal(release))),\n\t)\n\t.default(defaultVersion)\n\t.describe(`Solc compiler version to use. Defaults to ${defaultVersion}}`)\n\n/**\n * @typedef {import(\"zod\").infer<typeof compilerOptionValidator>} CompilerOption\n */\n\nconst bundlers = {\n\tsolc: bundler,\n}\n\n/**\n * @type {import(\"unplugin\").UnpluginFactory<{solc?: CompilerOption } | undefined, false>}\n */\nexport const tevmUnplugin = (options = {}) => {\n\t/**\n\t * @type {import(\"@tevm/config\").ResolvedCompilerConfig}\n\t */\n\tlet config\n\n\t// for current release we will hardcode this to solc\n\tconst parsedSolcVersion = compilerOptionValidator.safeParse(options.solc)\n\tif (!parsedSolcVersion.success) {\n\t\tconsole.error(parsedSolcVersion.error)\n\t\tthrow new Error(`Invalid solc compiler passed to Tevm plugin'`)\n\t}\n\n\tconst bundler = bundlers.solc\n\t/**\n\t * @type {ReturnType<typeof bundler>}\n\t */\n\tlet moduleResolver\n\n\treturn {\n\t\tname: '@tevm/rollup-plugin',\n\t\t/**\n\t\t * Make this plugin run before other plugins\n\t\t * We do this so other plugins (specifically webpack ones) don't barf on the solidity imports\n\t\t */\n\t\tenforce: 'pre',\n\t\tasync buildStart() {\n\t\t\tconfig = await runPromise(\n\t\t\t\tloadConfig(process.cwd()).pipe(\n\t\t\t\t\tcatchTag('FailedToReadConfigError', () =>\n\t\t\t\t\t\tlogWarning('Unable to find tevm.config.json. Using default config.').pipe(map(() => defaultConfig)),\n\t\t\t\t\t),\n\t\t\t\t),\n\t\t\t)\n\t\t\tconst solcCache = createCache(config.cacheDir, fao, process.cwd())\n\t\t\tconsole.log('proces.cwd()', process.cwd())\n\t\t\tconst contractPackage = getContractPath(process.cwd())\n\t\t\tconst versionedSolc =\n\t\t\t\tparsedSolcVersion.data === defaultVersion ? defaultSolc : await createSolc(parsedSolcVersion.data)\n\t\t\tmoduleResolver = bundler(config, console, fao, versionedSolc, solcCache, contractPackage)\n\t\t},\n\t\tloadInclude: (id) => {\n\t\t\treturn id.endsWith('.sol') && !fao.existsSync(`${id}.ts`) && !fao.existsSync(`${id}.d.ts`)\n\t\t},\n\t\tasync resolveId(id, importer) {\n\t\t\t// to handle the case where the import is coming from a node_module or a different workspace\n\t\t\t// we need to always point @tevm/contract to the local version\n\t\t\tif (\n\t\t\t\tid.startsWith('@tevm/contract') &&\n\t\t\t\t!importer?.startsWith(process.cwd()) &&\n\t\t\t\t!importer?.includes('node_modules')\n\t\t\t) {\n\t\t\t\treturn createRequire(`${process.cwd()}/`).resolve('@tevm/contract')\n\t\t\t}\n\t\t\treturn null\n\t\t},\n\t\tasync load(id) {\n\t\t\tconst resolveBytecode = id.endsWith('.s.sol')\n\n\t\t\tconst { code, modules } = await moduleResolver.resolveEsmModule(id, process.cwd(), false, resolveBytecode)\n\t\t\tObject.values(modules).forEach((module) => {\n\t\t\t\tif (module.id.includes('node_modules')) {\n\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t\tthis.addWatchFile(module.id)\n\t\t\t})\n\t\t\treturn code\n\t\t},\n\t\t...{ version: '0.11.2' },\n\t}\n}\n"]}