import * as _ethereumjs_statemanager from '@ethereumjs/statemanager';
import { StorageCache, AccountCache } from '@ethereumjs/statemanager';
export { AccountCache, CacheType, StorageCache } from '@ethereumjs/statemanager';
import { Logger, LogOptions } from '@tevm/logger';
import * as _tevm_utils from '@tevm/utils';
import { BlockTag, Hex as Hex$1 } from '@tevm/utils';
import * as viem from 'viem';
import { Hex, EIP1193RequestFn, Transport, Address } from 'viem';
import * as _tevm_common from '@tevm/common';
import { StorageDump, EvmStateManagerInterface } from '@tevm/common';

/**
 * Represents an Ethereum account storage with native bigint values.
 * Used for internal state management and account manipulation.
 * @example
 * ```typescript
 * import { AccountStorage } from '@tevm/state'
 *
 * const value: AccountStorage = {
 *   nonce: 0n,
 *   balance: 10000000000000000000n, // 10 ETH
 *   storageRoot: '0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421',
 *   codeHash: '0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470'
 * }
 * ```
 */
interface AccountStorage {
    nonce: bigint;
    balance: bigint;
    storageRoot: Hex;
    codeHash: Hex;
    deployedBytecode?: Hex;
    storage?: StorageDump;
}

/**
 * Configuration options for forking from an existing blockchain network.
 * Used to specify the RPC endpoint and block number to fork from.
 * @example
 * ```typescript
 * import { ForkOptions } from '@tevm/state'
 * import { http } from 'viem'
 *
 * const value: ForkOptions = {
 *   transport: http('https://mainnet.infura.io/v3/your-api-key'),
 *   blockTag: 'latest'
 * }
 * ```
 */
interface ForkOptions {
    transport: {
        request: EIP1193RequestFn;
    } | Transport;
    blockTag?: BlockTag | bigint;
}

/**
 * Represents an Ethereum account storage with hexadecimal string values.
 * Used to serialize account data for storage and RPC responses.
 * @example
 * ```typescript
 * import { ParameterizedAccountStorage } from '@tevm/state'
 *
 * const value: ParameterizedAccountStorage = {
 *   nonce: '0x0',
 *   balance: '0x1a784379d99db42000000',
 *   storageRoot: '0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421',
 *   codeHash: '0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470'
 * }
 * ```
 */
interface ParameterizedAccountStorage {
    nonce: Hex;
    balance: Hex;
    storageRoot: Hex;
    codeHash: Hex;
    storage?: StorageDump;
}

/**
 * API-friendly version of TevmState with hex string values.
 * Used for RPC responses and client-facing interfaces.
 * @example
 * ```typescript
 * import { ParameterizedTevmState } from '@tevm/state'
 *
 * const value: ParameterizedTevmState = {
 *   '0x1234567890123456789012345678901234567890': {
 *     nonce: '0x0',
 *     balance: '0x1a784379d99db42000000',
 *     storageRoot: '0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421',
 *     codeHash: '0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470'
 *   }
 * }
 * ```
 */
type ParameterizedTevmState = {
    [key: string]: ParameterizedAccountStorage;
};

/**
 * A serializable representation of Ethereum state with hex string values.
 * Used for persistence, transfer, or JSON serialization of state data.
 * @example
 * ```typescript
 * import { SerializableTevmState } from '@tevm/state'
 *
 * const value: SerializableTevmState = {
 *   '0x1234567890123456789012345678901234567890': {
 *     nonce: '0x0',
 *     balance: '0x1a784379d99db42000000',
 *     storageRoot: '0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421',
 *     codeHash: '0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470'
 *   }
 * }
 * ```
 */
type SerializableTevmState = {
    [key: string]: {
        nonce: Hex;
        balance: Hex;
        storageRoot: Hex;
        codeHash: Hex;
        deployedBytecode?: Hex;
        storage?: StorageDump;
    };
};

/**
 * @internal
 * The core data structure powering the state manager internally
 */
type BaseState = {
    ready: () => Promise<true>;
    logger: Logger;
    /**
     * Mapping of hashes to State roots
     */
    stateRoots: StateRoots;
    options: StateOptions;
    caches: StateCache;
    forkCache: StateCache;
    getCurrentStateRoot: () => Hex$1;
    setCurrentStateRoot: (newStateRoot: Hex$1) => void;
};

interface StateManager extends EvmStateManagerInterface {
    /**
     * The internal state representation
     */
    _baseState: BaseState;
    ready: BaseState['ready'];
    /**
     * Returns contract addresses
     */
    getAccountAddresses: () => Set<Address>;
    /**
     * Returns a new instance of the ForkStateManager with the same opts and all storage copied over
     */
    deepCopy(): Promise<StateManager>;
    /**
     * Dumps the state of the state manager as a {@link TevmState}
     */
    dumpCanonicalGenesis(): Promise<TevmState>;
    /**
     * Resets all internal caches
     */
    clearCaches(): void;
    /**
     * @experimental
     * Saves a state root to the state root mapping
     * THis API is considered unstable
     */
    saveStateRoot(root: Uint8Array, state: TevmState): void;
    /**
     * Commits the current state.
     */
    commit(
    /**
     * @experimental
     * Whether to create a new state root
     * Defaults to true.
     * This api is not stable
     */
    createNewStateRoot?: boolean): Promise<void>;
    /**
     * Clears all storage entries for the account
     */
    clearContractStorage(address: _tevm_utils.EthjsAddress): Promise<void>;
    /**
     * Dumps storage based on the input
     */
    dumpStorage(address: _tevm_utils.EthjsAddress): Promise<_tevm_common.StorageDump>;
    /**
     * Dumps a range of storage values
     */
    dumpStorageRange(address: _tevm_utils.EthjsAddress, startKey: bigint, limit: number): Promise<_tevm_common.StorageRange>;
    /**
     * Loads a state from a given state root
     */
    generateCanonicalGenesis(state: TevmState): Promise<void>;
    /**
     * Get an EIP-1186 proof from the provider
     * @param address - The address to get proof for
     * @param storageSlots - Storage slots to include in the proof
     * @returns The account and storage proof
     */
    getProof(address: _tevm_utils.EthjsAddress, storageSlots?: Uint8Array[]): Promise<_ethereumjs_statemanager.Proof>;
}

type StateAction<T extends keyof StateManager> = (baseState: BaseState, skipFetchingFromFork?: boolean) => StateManager[T];

/**
 * Contract cache is a mapping of addresses to deployedBytecode
 * It is implemented via extending StorageCache and hardcoding slot 0
 */
declare class ContractCache {
    constructor(storageCache?: StorageCache);
    storageCache: StorageCache;
    /**
     * @returns {void}
     */
    commit(): void;
    /**
     * @returns {void}
     */
    clear(): void;
    /**
     * @param {import('@tevm/utils').EthjsAddress} address
     * @returns {Uint8Array | undefined}
     */
    get(address: _tevm_utils.EthjsAddress): Uint8Array | undefined;
    /**
     * @param {import('@tevm/utils').EthjsAddress} address
     * @param {Uint8Array} bytecode
     * @returns {void}
     */
    put(address: _tevm_utils.EthjsAddress, bytecode: Uint8Array): void;
    /**
     * @param {import('@tevm/utils').EthjsAddress} address
     * @returns {void}
     */
    del(address: _tevm_utils.EthjsAddress): void;
    /**
     * @returns {void}
     */
    checkpoint(): void;
    /**
     * @param {import('@tevm/utils').EthjsAddress} address
     * @returns {boolean} if the cache has the key
     */
    has(address: _tevm_utils.EthjsAddress): boolean;
    get _checkpoints(): number;
    size(): number;
    /**
     * @returns {void}
     */
    revert(): void;
}

/**
 * @internal
 * The shape of the internal cache
 */
type StateCache = {
    accounts: AccountCache;
    storage: StorageCache;
    contracts: ContractCache;
};

/**
 * A map of Ethereum addresses to their account storage data.
 * Represents the entire state of an Ethereum network at a given point.
 * @example
 * ```typescript
 * import { TevmState } from '@tevm/state'
 *
 * const value: TevmState = {
 *   '0x1234567890123456789012345678901234567890': {
 *     nonce: 0n,
 *     balance: 10000000000000000000n,
 *     storageRoot: '0x56e81f171bcc55a6ff8345e692c0f86e5b48e01b996cadc001622fb5e363b421',
 *     codeHash: '0xc5d2460186f7233c927e7db2dcc703c0e500b653ca82273b7bfad8045d85a470'
 *   }
 * }
 * ```
 */
type TevmState = {
    [key: Address]: AccountStorage;
};

/**
 * Mapping of state roots as hex string to the state
 */
type StateRoots = Map<Hex$1, TevmState>;

/**
 * Configuration options for the Tevm state manager.
 * Controls forking, initial state, caching, and event handling.
 * @example
 * ```typescript
 * import { StateOptions } from '@tevm/state'
 * import { http } from 'viem'
 *
 * const value: StateOptions = {
 *   fork: {
 *     transport: http('https://mainnet.infura.io/v3/your-api-key'),
 *     blockTag: 'latest'
 *   },
 *   loggingLevel: 'debug'
 * }
 * ```
 */
type StateOptions = {
    fork?: ForkOptions;
    genesisState?: TevmState;
    currentStateRoot?: Hex;
    stateRoots?: StateRoots;
    /**
     * Called when state manager commits state
     */
    onCommit?: (stateManager: BaseState) => void;
    /**
     * Configure logging options for the client
     */
    readonly loggingLevel?: LogOptions['level'];
    /**
     * Optionally configure and pass in your own ContractCache
     */
    readonly contractCache?: ContractCache;
    /**
     * Optionally configure and pass in your own StorageCache
     */
    readonly storageCache?: StorageCache;
    /**
     * Optionally configure the accounts cache
     */
    readonly accountsCache?: AccountCache;
};

/**
 * Checkpoints the current change-set to the instance since the
 * last call to checkpoint.
 * @type {import("../state-types/index.js").StateAction<'checkpoint'>}
 */
declare const checkpoint: StateAction<"checkpoint">;

/**
 * Resets all internal caches
 * @type {import("../state-types/index.js").StateAction<'clearCaches'>}
 */
declare const clearCaches: StateAction<"clearCaches">;

declare function clearContractStorage(baseState: BaseState): (address: _tevm_utils.EthjsAddress) => Promise<void>;

/**
 * Commits the current change-set to the instance since the
 * last call to checkpoint.
 * @type {import("../state-types/index.js").StateAction<'commit'>}
 */
declare const commit: StateAction<"commit">;

declare function deepCopy(baseState: BaseState): () => Promise<BaseState>;

/**
 * Deletes an account from state under the provided `address`.
 * @type {import("../state-types/index.js").StateAction<'deleteAccount'>}
 */
declare const deleteAccount: StateAction<"deleteAccount">;

/**
 * Dumps the state of the state manager as a {@link TevmState}
 * @type {import("../state-types/index.js").StateAction<'dumpCanonicalGenesis'>}
 */
declare const dumpCanonicalGenesis: StateAction<"dumpCanonicalGenesis">;

/**
 * Dumps the RLP-encoded storage values for an `account` specified by `address`.
 * Keys are the storage keys, values are the storage values as strings.
 * Both are represented as `0x` prefixed hex strings.
 * @type {import("../state-types/index.js").StateAction<'dumpStorage'>}
 */
declare const dumpStorage: StateAction<"dumpStorage">;

/**
 * @type {import("../state-types/index.js").StateAction<'dumpStorageRange'>}
 */
declare const dumpStorageRange: StateAction<"dumpStorageRange">;

/**
 * Loads a {@link TevmState} into the state manager
 * @type {import("../state-types/index.js").StateAction<'generateCanonicalGenesis'>}
 */
declare const generateCanonicalGenesis: StateAction<"generateCanonicalGenesis">;

/**
 * Gets the account corresponding to the provided `address`.
 * Returns undefined if account does not exist.
 *
 * When running in fork mode:
 * 1. First checks main cache for the account
 * 2. Then checks fork cache if main cache misses
 * 3. Finally fetches from remote provider if neither cache has the account
 * 4. When fetched from remote, stores in both main and fork caches
 *
 * @type {import("../state-types/index.js").StateAction<'getAccount'>}
 */
declare const getAccount: StateAction<"getAccount">;

/**
 * @type {import("../state-types/index.js").StateAction<'getAccountAddresses'>}
 */
declare const getAccountAddresses: StateAction<"getAccountAddresses">;

declare function getAccountFromProvider(baseState: BaseState): (address: _tevm_utils.EthjsAddress) => Promise<_tevm_utils.EthjsAccount>;

/**
 * @deprecated
 * Returns the applied key for a given address
 * Used for saving preimages
 * @type {import("../state-types/index.js").StateAction<'getAppliedKey'>}
 */
declare const getAppliedKey: StateAction<"getAppliedKey">;

declare function getContractCode(baseState: BaseState, skipFetchingFromFork?: boolean): (address: _tevm_utils.EthjsAddress) => Promise<Uint8Array>;

declare function getContractStorage(baseState: BaseState): (address: _tevm_utils.EthjsAddress, key: Uint8Array) => Promise<Uint8Array>;

declare function getForkBlockTag({ options: { fork } }: BaseState): undefined | {
    blockTag: viem.BlockTag;
} | {
    blockNumber: bigint;
};

declare function getForkClient({ options: { fork } }: BaseState): viem.PublicClient;

declare function getProof(baseState: BaseState): (address: _tevm_utils.EthjsAddress, storageSlots?: Uint8Array[]) => Promise<_ethereumjs_statemanager.Proof>;

/**
 * Gets the current state root
 * @type {import("../state-types/index.js").StateAction<'getStateRoot'>}
 */
declare const getStateRoot: StateAction<"getStateRoot">;

/**
 * Returns true if state root exists
 * @type {import("../state-types/index.js").StateAction<'hasStateRoot'>}
 */
declare const hasStateRoot: StateAction<"hasStateRoot">;

/**
 * Gets the account associated with `address`, modifies the given account
 * fields, then saves the account into state. Account fields can include
 * `nonce`, `balance`, `storageRoot`, and `codeHash`.
 * @type {import("../state-types/index.js").StateAction<'modifyAccountFields'>}
 */
declare const modifyAccountFields: StateAction<"modifyAccountFields">;

/**
 * Commits the current change-set to the instance since the
 * last call to checkpoint.
 * @type {import("../state-types/index.js").StateAction<'originalStorageCache'>}
 */
declare const originalStorageCache: StateAction<"originalStorageCache">;

/**
 * Saves an account into state under the provided `address`.
 * @type {import("../state-types/index.js").StateAction<'putAccount'>}
 */
declare const putAccount: StateAction<"putAccount">;

declare function putContractCode(baseState: BaseState): (address: _tevm_utils.EthjsAddress, value: Uint8Array) => Promise<void>;

declare function putContractStorage(baseState: BaseState): (address: _tevm_utils.EthjsAddress, key: Uint8Array, value: Uint8Array) => Promise<void>;

/**
 * Commits the current change-set to the instance since the
 * last call to checkpoint.
 * @type {import("../state-types/index.js").StateAction<'revert'>}
 */
declare const revert: StateAction<"revert">;

/**
 * Changes the currently loaded state root
 * @type {import("../state-types/index.js").StateAction<'setStateRoot'>}
 */
declare const setStateRoot: StateAction<"setStateRoot">;

declare function shallowCopy(baseState: BaseState): () => BaseState;

declare function createBaseState(options: StateOptions): BaseState;

declare function createStateManager(options: StateOptions): StateManager;

export { type AccountStorage, type BaseState, ContractCache, type ForkOptions, type ParameterizedAccountStorage, type ParameterizedTevmState, type SerializableTevmState, type StateAction, type StateCache, type StateManager, type StateOptions, type StateRoots, type TevmState, checkpoint, clearCaches, clearContractStorage, commit, createBaseState, createStateManager, deepCopy, deleteAccount, dumpCanonicalGenesis, dumpStorage, dumpStorageRange, generateCanonicalGenesis, getAccount, getAccountAddresses, getAccountFromProvider, getAppliedKey, getContractCode, getContractStorage, getForkBlockTag, getForkClient, getProof, getStateRoot, hasStateRoot, modifyAccountFields, originalStorageCache, putAccount, putContractCode, putContractStorage, revert, setStateRoot, shallowCopy };
