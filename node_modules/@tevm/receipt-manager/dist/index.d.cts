import * as _tevm_utils from '@tevm/utils';
import { Hex, EthjsLog } from '@tevm/utils';
import { Block } from '@tevm/block';
import { Chain } from '@tevm/blockchain';
import { TransactionType, TypedTransaction } from '@tevm/tx';

/**
 * Types of database entries used by the receipt manager and other components
 */
type DbType = 'Receipts' | 'TxHash' | 'SkeletonBlock' | 'SkeletonBlockHashToNumber' | 'SkeletonStatus' | 'SkeletonUnfinalizedBlockByHash' | 'Preimage';
/**
 * Options for creating a MapDb instance
 */
interface MetaDBManagerOptions {
    /**
     * Map used as the cache for the database
     */
    cache: Map<Hex, Uint8Array>;
}
/**
 * Helper class to access the metaDB with methods for managing receipts and transaction data
 */
type MapDb = {
    /**
     * Store a value in the database
     * @param type - The type of data being stored
     * @param hash - The hash key for the data
     * @param value - The value to store
     */
    put(type: DbType, hash: Uint8Array, value: Uint8Array): Promise<void>;
    /**
     * Retrieve a value from the database
     * @param type - The type of data to retrieve
     * @param hash - The hash key for the data
     * @returns The stored value or null if not found
     */
    get(type: DbType, hash: Uint8Array): Promise<Uint8Array | null>;
    /**
     * Delete a value from the database
     * @param type - The type of data to delete
     * @param hash - The hash key for the data to delete
     */
    delete(type: DbType, hash: Uint8Array): Promise<void>;
    /**
     * Create a deep copy of the MapDb instance
     * @returns A new MapDb instance with a copy of the data
     */
    deepCopy(): MapDb;
};

declare function createMapDb({ cache }: {
    cache: Map<_tevm_utils.Hex, Uint8Array>;
}): MapDb;

/**
 * Abstract interface with common transaction receipt fields that all receipt types share
 * This serves as the base for both pre and post-Byzantium transaction receipts
 */
interface BaseTxReceipt {
    /**
     * Cumulative gas used in the block including this transaction
     * Represented as a bigint to handle large gas values accurately
     */
    cumulativeBlockGasUsed: bigint;
    /**
     * Bloom filter bitvector containing indexed log data
     * Used for efficient searching of logs in the blockchain
     */
    bitvector: Uint8Array;
    /**
     * Array of logs emitted during transaction execution
     * Each log contains address, topics, and data fields
     */
    logs: EthjsLog[];
}
/**
 * Receipt type for Byzantium and beyond (EIP-658)
 * Replaces the intermediary state root field with a status code field
 * Introduced in the Byzantium hard fork
 */
interface PostByzantiumTxReceipt extends BaseTxReceipt {
    /**
     * Status of transaction execution
     * - `1` if successful
     * - `0` if an exception occurred during execution
     */
    status: 0 | 1;
}
/**
 * Pre-Byzantium receipt type used before the Byzantium hard fork
 * Contains a state root field instead of the status code used in later versions
 */
interface PreByzantiumTxReceipt extends BaseTxReceipt {
    /**
     * Intermediary state root after transaction execution
     * This is a 32-byte Merkle root of the state trie
     */
    stateRoot: Uint8Array;
}
/**
 * Receipt type for EIP-4844 blob transactions
 * Extends the post-Byzantium receipt with additional blob gas fields
 */
interface EIP4844BlobTxReceipt extends PostByzantiumTxReceipt {
    /**
     * Amount of blob gas consumed by the transaction
     *
     * Note: This value is not included in the receiptRLP used for encoding the receiptsRoot in a block
     * and is only provided as part of receipt metadata.
     */
    blobGasUsed: bigint;
    /**
     * Price of blob gas for the block the transaction was included in
     *
     * Note: This value is not included in the `receiptRLP` used for encoding the `receiptsRoot` in a block
     * and is only provided as part of receipt metadata.
     */
    blobGasPrice: bigint;
}
/**
 * Union type of all transaction receipt types
 * Can be pre-Byzantium, post-Byzantium, or EIP-4844 blob receipt
 */
type TxReceipt = PreByzantiumTxReceipt | PostByzantiumTxReceipt | EIP4844BlobTxReceipt;
/**
 * TxReceiptWithType extends TxReceipt to provide transaction type information
 * This is used when the receipt needs to include the transaction type (EIP-2718)
 */
type TxReceiptWithType = PreByzantiumTxReceiptWithType | PostByzantiumTxReceiptWithType;
/**
 * Pre-Byzantium receipt type with transaction type information
 * Extends the pre-Byzantium receipt with the EIP-2718 transaction type
 */
interface PreByzantiumTxReceiptWithType extends PreByzantiumTxReceipt {
    /**
     * EIP-2718 Typed Transaction Envelope type
     * Indicates which transaction format was used
     */
    txType: TransactionType;
}
/**
 * Post-Byzantium receipt type with transaction type information
 * Extends the post-Byzantium receipt with the EIP-2718 transaction type
 */
interface PostByzantiumTxReceiptWithType extends PostByzantiumTxReceipt {
    /**
     * EIP-2718 Typed Transaction Envelope type
     * Indicates which transaction format was used
     */
    txType: TransactionType;
}
/**
 * Return type for getReceiptByTxHash method containing the receipt and its metadata
 * Used to format responses for RPC methods like eth_getTransactionReceipt
 */
type GetReceiptByTxHashReturn = [receipt: TxReceipt, blockHash: Uint8Array, txIndex: number, logIndex: number];
/**
 * Return type for getLogs method containing log entries with their associated block and transaction data
 * Used to format responses for RPC methods like eth_getLogs
 */
type GetLogsReturn = {
    /** The log entry containing address, topics, and data */
    log: EthjsLog;
    /** The block containing the transaction that produced this log */
    block: Block;
    /** The transaction that produced this log */
    tx: TypedTransaction;
    /** Index of the transaction within the block */
    txIndex: number;
    /** Global index of the log within the block */
    logIndex: number;
}[];
/**
 * Manages transaction receipts within the Ethereum virtual machine
 * Provides methods for storing, retrieving, and searching transaction receipts and logs
 */
declare class ReceiptsManager {
    readonly mapDb: MapDb;
    readonly chain: Chain;
    /**
     * Creates a new ReceiptsManager instance
     * @param mapDb - The database instance for storing receipts and indexes
     * @param chain - The blockchain instance for retrieving blocks
     */
    constructor(mapDb: MapDb, chain: Chain);
    /**
     * Maximum number of logs to return in getLogs
     * This prevents excessive memory usage and response size
     */
    GET_LOGS_LIMIT: number;
    /**
     * Maximum size of getLogs response in megabytes
     * This prevents excessive memory usage and response size
     */
    GET_LOGS_LIMIT_MEGABYTES: number;
    /**
     * Maximum block range that can be queried in a single getLogs call
     * This prevents excessive computational load from large queries
     */
    GET_LOGS_BLOCK_RANGE_LIMIT: number;
    /**
     * Creates a deep copy of this ReceiptsManager with a new chain reference
     * Useful for creating a snapshot of the current state
     *
     * @param chain - The new chain reference to use
     * @returns A new ReceiptsManager instance with copied state
     */
    deepCopy(chain: Chain): ReceiptsManager;
    /**
     * Saves transaction receipts to the database for a given block
     * Also builds and saves transaction hash indexes for efficient lookups
     *
     * @param block - The block containing the transactions
     * @param receipts - The transaction receipts to save
     * @returns Promise that resolves when saving is complete
     *
     * @example
     * const block = await chain.getBlock(blockNumber)
     * await receiptManager.saveReceipts(block, txReceipts)
     */
    saveReceipts(block: Block, receipts: TxReceipt[]): Promise<void>;
    /**
     * Deletes transaction receipts and their indexes for a given block
     * Used when removing or replacing block data
     *
     * @param block - The block whose receipts should be deleted
     * @returns Promise that resolves when deletion is complete
     *
     * @example
     * const block = await chain.getBlock(blockNumber)
     * await receiptManager.deleteReceipts(block)
     */
    deleteReceipts(block: Block): Promise<void>;
    /**
     * Retrieves transaction receipts for a given block hash
     * Can optionally calculate bloom filters and include transaction types
     *
     * @param blockHash - The hash of the block to get receipts for
     * @param calcBloom - Whether to calculate and include bloom filters (default: false)
     * @param includeTxType - Whether to include transaction types in the receipts (default: false)
     * @returns Promise resolving to an array of transaction receipts
     *
     * @example
     * // Get basic receipts
     * const receipts = await receiptManager.getReceipts(blockHash)
     *
     * // Get receipts with bloom filters and transaction types
     * const receiptsWithDetails = await receiptManager.getReceipts(blockHash, true, true)
     */
    getReceipts(blockHash: Uint8Array, calcBloom?: boolean, includeTxType?: true): Promise<TxReceiptWithType[]>;
    getReceipts(blockHash: Uint8Array, calcBloom?: boolean, includeTxType?: false): Promise<TxReceipt[]>;
    /**
     * Retrieves a transaction receipt by transaction hash
     * Also returns additional metadata needed for JSON-RPC responses
     *
     * @param txHash - The transaction hash to look up
     * @returns Promise resolving to receipt data or null if not found
     *
     * @example
     * const receiptData = await receiptManager.getReceiptByTxHash(txHash)
     * if (receiptData) {
     *   const [receipt, blockHash, txIndex, logIndex] = receiptData
     *   // Use receipt data
     * }
     */
    getReceiptByTxHash(txHash: Uint8Array): Promise<GetReceiptByTxHashReturn | null>;
    /**
     * Retrieves logs matching the specified criteria within a block range
     * Implements the core functionality of eth_getLogs JSON-RPC method
     * Enforces size and count limits to prevent excessive resource usage
     *
     * @param from - The starting block
     * @param to - The ending block
     * @param addresses - Optional array of addresses to filter logs by
     * @param topics - Optional array of topics to filter logs by, can include arrays and nulls
     * @returns Promise resolving to array of matching logs with metadata
     *
     * @example
     * // Get all logs between blocks 100 and 200
     * const logs = await receiptManager.getLogs(block100, block200)
     *
     * // Get logs from a specific contract
     * const logs = await receiptManager.getLogs(block100, block200, [contractAddress])
     *
     * // Get logs with specific topics
     * const logs = await receiptManager.getLogs(block100, block200, undefined, [eventTopic])
     */
    getLogs(from: Block, to: Block, addresses?: Uint8Array[], topics?: (Uint8Array | Uint8Array[] | null)[]): Promise<GetLogsReturn>;
    /**
     * Updates indexes in the database based on the operation type
     * Used internally to maintain transaction hash to receipt mappings
     *
     * @param operation - Whether to save or delete indexes
     * @param type - The type of index to update
     * @param value - The data used to update indexes (typically a block)
     * @returns Promise that resolves when the update is complete
     * @private
     */
    private updateIndex;
    /**
     * Retrieves an index value from the database
     * Used internally to look up transaction hash mappings
     *
     * @param type - The type of index to retrieve
     * @param value - The key to look up (typically a transaction hash)
     * @returns Promise resolving to the index value or null if not found
     * @private
     */
    private getIndex;
    /**
     * Encodes or decodes data using RLP serialization for database storage
     * Supports different data types and formats based on the parameters
     *
     * @param conversion - Whether to encode or decode
     * @param type - The type of data being processed
     * @param value - The data to encode or decode
     * @returns Encoded bytes or decoded data structures
     * @private
     */
    private rlp;
    /**
     * Calculates a Bloom filter for a set of transaction logs
     * Used for efficient log filtering and lookups
     *
     * @param logs - The logs to include in the bloom filter
     * @returns A Bloom filter containing the log data
     * @private
     */
    private logsBloom;
}

export { type BaseTxReceipt, type DbType, type EIP4844BlobTxReceipt, type MapDb, type MetaDBManagerOptions, type PostByzantiumTxReceipt, type PreByzantiumTxReceipt, ReceiptsManager, type TxReceipt, type TxReceiptWithType, createMapDb };
